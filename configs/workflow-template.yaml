apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: ci-template
spec:
  arguments:
    parameters:
      - name: repo
        value:
      - name: branch
        value: master

  entrypoint: main
  onExit: image

  volumeClaimTemplates:
    - metadata:
        name: work
      spec:
        accessModes: [ ReadWriteOnce ]
        resources:
          requests:
            storage: 1Gi

  templates:
    - name: main
      dag:
        tasks:
          - name: clone
            template: clone
          - name: deps
            template: deps
            dependencies:
              - clone
          - name: build
            template: build
            dependencies:
              - deps

    - name: image
      container:
        volumeMounts:
          - mountPath: /app
            name: work
        image: moby/buildkit:latest
        workingDir: /app
        command: [ sh, -xuce ]
        # buildctl --creds username:password --registry myregistry.example.com:5000 build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=image,name=myimage,push=true .
        args: 
          - |
            buildctl --creds username:password --registry myregistry.example.com:5000 build --frontend dockerfile.v0 --local context=. --local dockerfile=. --output type=image,name={{workflow.parameters.image}},push=true

    - name: clone
      container:
        volumeMounts:
          - mountPath: /app
            name: work
        image: bitnami/git:latest
        workingDir: /app
        command: [ sh, -xuce ]
        args:
          - |
            git clone -v -b "{{workflow.parameters.branch}}" --single-branch --depth 1 "{{workflow.parameters.repo}}" .

    - name: deps
      container:
        image: golang:1.19
        volumeMounts:
          - mountPath: /app
            name: work
        workingDir: /app
        command: [ sh, -xuce ]
        args:
          - |
            make generate 

    - name: build
      container:
        image: golang:1.19
        volumeMounts:
          - mountPath: /app
            name: work
        workingDir: /app
        command: [ sh, -xuce ]
        args:
          - |
            make build
